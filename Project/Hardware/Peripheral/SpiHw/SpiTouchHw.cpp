///////////////////////////////////////////////////////////////////////////////
//////////////////////////////// INCLUDES /////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

#include "GpioHw.h"
#include "LoggerHw.h"
#include "SpiTouchHw.h"
#include "driver/gpio.h"
#include "driver/spi_master.h"

///////////////////////////////////////////////////////////////////////////////
//////////////////////////////// VARIABLES ////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

spi_device_handle_t SpiTouchHw::handle;

///////////////////////////////////////////////////////////////////////////////
//////////////////////////////// FUNCTIONS ////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

SpiTouchHw::SpiTouchHw () : SpiHw (&handle)
{
    LOG (MODULE, "Init.");

    static spi_bus_config_t busConfig;
    busConfig.miso_io_num       = static_cast<int> (GpioHw::ETouch::eDin);
    busConfig.mosi_io_num       = static_cast<int> (GpioHw::ETouch::eDo);
    busConfig.sclk_io_num       = static_cast<int> (GpioHw::ETouch::eClk);
    busConfig.quadwp_io_num     = -1;
    busConfig.quadhd_io_num     = -1;
    busConfig.max_transfer_sz   = THIRTY_TWO_BYTES;

    static spi_device_interface_config_t deviceConfig;
    deviceConfig.clock_speed_hz = ONE_HUNDRED_TWENTY_FIVE * ONE_THOUSAND;      // Clock out at 125 kHz
    deviceConfig.mode           = static_cast<uint8_t>(EMode::eCmd);
    deviceConfig.spics_io_num   = static_cast<int>    (GpioHw::ETouch::eCs);
    deviceConfig.queue_size     = FIVE;

    esp_err_t status            = spi_bus_initialize (host, &busConfig, dmaChannel);
    ESP_ERROR_CHECK (status);

    status                      = spi_bus_add_device (host, &deviceConfig, &handle);
    ESP_ERROR_CHECK (status);
}

///////////////////////////////////////////////////////////////////////////////
/////////////////////////////// END OF FILE ///////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
